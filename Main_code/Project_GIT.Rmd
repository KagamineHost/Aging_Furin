---
title: "FURIN stimulates NOTCH2 and NOTCH3 Pathways Leading to Return of Function in Aged Muscle Cells"
output: html_document
date: "2024-06-28"
---

```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(tidyverse)
  library(DESeq2)
  library(magrittr)
  library(GOstats)
  library(Category)
  library(GO.db)
  library(org.Hs.eg.db)
  library(biomaRt)
  library(clusterProfiler)
  library(RColorBrewer)
  library(ggGenshin)
})

```

# lower leg

## Data and metadata

```{r}
metadata <- read.delim("V8/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt")

data <- read.delim('V8/gene_reads_skin_sun_exposed_lower_leg.gct', skip = 2)
```

```{r}
metadata
head(data)
```

```{r}
#png(filename="Metadata.png")
barplot(table(metadata$AGE), main="Metadata") %>%
  text(y = table(metadata$AGE)-15, labels = table(metadata$AGE))
#dev.off()
```



#### Notch related gene

```{r}
notch_gene <- read.csv('Molecules.csv')
notch_gene = notch_gene[notch_gene$converted_alias != 'None',]
```

```{r}
# DNA/RNA
notch_DNA <- notch_gene$Identifier[grepl("^ENSG", notch_gene$Identifier)]
```

```{r}
# Protein
notch_protein <- notch_gene$Identifier[notch_gene$MoleculeType=='Proteins']
```

```{r}
notch_protein.ENSEMBL <- mapIds(org.Hs.eg.db, keys = notch_protein, keytype = 'UNIPROT', column = 'ENSEMBL')
```


## Data reform

Prepare metadata

```{r}
## Each sample is named after GTEX.ID.XXXX. Extract the code after GTEX as ID
id_data <- str_split(colnames(data)[c(-1,-2,-3)], pattern = "\\.", simplify = TRUE)[,2]


# Change ID in metadata
metadata$ID <- str_split(metadata$SUBJID, pattern = "-", simplify = TRUE)[,2]
metadata$AGE <- factor(metadata$AGE)

# Merge data and metadata
metadata_transfrom <- merge(x = data.frame(ID = id_data, Name = colnames(data)[c(-1,-2,-3)]), y = metadata, by = "ID", all.x = TRUE)
rownames(metadata_transfrom) <- metadata_transfrom$Name
```

```{r}
metadata_transfrom
```

Extract counts

```{r}
counts <- data[,c(-1,-2,-3)]
rownames(counts) <- data$Name
```

```{r}
# Set 20-29 as control
metadata_transfrom$AGE <-  relevel(metadata_transfrom$AGE, ref = '20-29')
```

## Create DESeq2 object

```{r}
dds <- DESeqDataSetFromMatrix(counts, 
                              colData = metadata_transfrom, 
                              design = ~ AGE)
```

### Run DESeq2

```{r}
# Run DESeq2 
dds <- DESeq(dds, test = 'LRT', reduced = ~1)
```

### Results

```{r}
resultsNames(dds)
res.name <- resultsNames(dds)[-1]
```


### notch related DNA/RNA

Likelihood ratio test (LRT) is used to identify any genes that show change in expression across the different levels.

```{r}
# Set thresholds to select gene with adjust p < 0.05 and log2FoldChange greater than 1 or less than -1.
padj_cutoff <- 0.05
res.list <- list()

res.list.notch <- list()
for (i in (res.name)){
  res <- results(dds, name = i, test = 'LRT') 
  # Turn the results object into a tibble for use with tidyverse functions
  res_tbl <- res %>%
        data.frame() %>%
        rownames_to_column(var="gene") %>%
        as_tibble()

  # Subset the significant results
  notch_res <- dplyr::filter(res_tbl, str_extract(gene, pattern = '.+(?=\\.)') %in% notch_DNA&padj < padj_cutoff) %>%
        dplyr::arrange(padj)
  
  # Save DEG
  res.list.notch[[i]] <- notch_res
}
```


```{r}
res.notch.SYMBOL <- mapIds(org.Hs.eg.db, keys = str_extract(res.list.notch[[1]]$gene, pattern = '.+(?=\\.)'), keytype = 'ENSEMBL', column = 'SYMBOL' )
res.notch.SYMBOL
```

### notch related proteins

```{r}
res.list.notch.proteins <- list()
for (i in (res.name)){
  res <- results(dds, name = i, test = 'LRT') 
  # Turn the results object into a tibble for use with tidyverse functions
  res_tbl <- res %>%
        data.frame() %>%
        rownames_to_column(var="gene") %>%
        as_tibble()

  # Subset the significant results
  notch_res <- dplyr::filter(res_tbl, str_extract(gene, pattern = '.+(?=\\.)') %in% notch_gene$converted_alias&padj < padj_cutoff) %>%
        dplyr::arrange(padj)
  
  notch_res
  
  # Save DEG
  res.list.notch.proteins[[i]] <- notch_res
}
```

```{r}
res.notch.SYMBOL.protien <- mapIds(org.Hs.eg.db, keys = str_extract(res.list.notch.proteins[[1]]$gene, pattern = '.+(?=\\.)'), keytype = 'ENSEMBL', column = 'SYMBOL' )
res.notch.SYMBOL.protien
```

### Spearman test on the correlation between age and genes expression value

```{r}
normalized_counts <- counts(dds, normalized = TRUE)
```

DNA/RNA
```{r}

DEGs.notch = rownames(counts)
for (i in res.name){
  DEGs.notch <- intersect(DEGs.notch, res.list.notch[[i]]$gene)
}

sig_norm <- data.frame(normalized_counts) %>%
    rownames_to_column(var = "gene") %>%
    dplyr::filter(gene %in% DEGs.notch)

arrange(metadata_transfrom,AGE) %>%
  select(AGE) -> ann.col

mat<- sig_norm[ , 2:length(colnames(sig_norm))]
mat <- mat[,rownames(ann.col)]
```

```{r}
cor.test.res <- data.frame()
for (i in (1:length(res.notch.SYMBOL))){
  target = res.notch.SYMBOL[i]
  id = names(res.notch.SYMBOL)[i]
  loc = which(str_extract(sig_norm[,1], pattern = '.+(?=\\.)')==id)
  cor.test.res[i,1] <- id #ENSEMBL
  cor.test.res[i,2] <- target #SYMBOL
  
  df <- cbind(t(mat[loc,]), ann.col)
  colnames(df) <- c('Expression', 'Age')
  cor.temp = cor.test(rank(df$Age), y = as.numeric(df$Expression), method = 'spearman')

  cor.test.res[i,3] <- as.numeric(cor.temp[4]) #Rho
  cor.test.res[i,4] <- as.numeric(cor.temp[3]) #Pvalue
}
colnames(cor.test.res) <- c('ENSEMBL', 'SYMBOL', 'Rho', 'Pvalue')
```

```{r}
write.csv(cor.test.res, file = 'Results/Skin_lower_leg/Cor_test_res_skin_lower_leg.csv')
```


Protein

```{r}
DEGs.notch.proteins = rownames(counts)
for (i in res.name){
  DEGs.notch.proteins <- intersect(DEGs.notch.proteins, res.list.notch.proteins[[i]]$gene)
}

sig_norm.proteins <- data.frame(normalized_counts) %>%
    rownames_to_column(var = "gene") %>%
    dplyr::filter(gene %in% DEGs.notch.proteins)

mat.proteins <- sig_norm.proteins[ , 2:length(colnames(sig_norm.proteins))]
colnames(mat.proteins) <- str_split(colnames(mat.proteins), pattern = "\\.", simplify = TRUE)[,2]
mat.proteins <- mat.proteins[,rownames(ann.col)]
```

```{r}
cor.test.res.protein <- data.frame()
for (i in (1:length(res.notch.SYMBOL.protien))){
  target = res.notch.SYMBOL.protien[i]
  id = names(res.notch.SYMBOL.protien)[i]
  loc = which(str_extract(sig_norm.proteins[,1], pattern = '.+(?=\\.)')==id)
  cor.test.res.protein[i,1] <- id #ENSEMBL
  cor.test.res.protein[i,2] <- target #SYMBOL
  
  df <- cbind(t(mat.proteins[loc,]), ann.col)
  colnames(df) <- c('Expression', 'Age')
  cor.temp = cor.test(rank(df$Age), y = as.numeric(df$Expression), method = 'spearman')

  cor.test.res.protein[i,3] <- as.numeric(cor.temp[4]) #Rho
  cor.test.res.protein[i,4] <- as.numeric(cor.temp[3]) #Pvalue
}
colnames(cor.test.res.protein) <- c('ENSEMBL', 'SYMBOL', 'Rho', 'Pvalue')
```
```{r}
write.csv(cor.test.res, file = 'Results/Skin_lower_leg/Cor_test_res_protein_skin_lower_leg.csv')
```


## Visualization
### Metadata bar plot
```{r}
#png(filename="Metadata_Lower_leg.png")
barplot(table(ann.col$AGE), main="Metadata - Lower leg") %>%
  text(y = table(ann.col$AGE) - 10, labels = table(ann.col$AGE))
#dev.off()
```

### Box plot
```{r}
targets = c('NOTCH2', 'NOTCH3','FURIN', 'GZMB')
```

```{r}
for (n in 1:length(targets)){
  target = targets[n]
  print(target)
  i = which(res.notch.SYMBOL.protien==target)
  i = names(res.notch.SYMBOL.protien)[i]
  i = which(str_extract(sig_norm.proteins[,1], pattern = '.+(?=\\.)')==i)
    
  ggplot(df, aes(x=Age, y=Expression)) +
      geom_boxplot()+
    ggtitle(res.notch.SYMBOL.protien[str_extract(sig_norm.proteins[i,1], pattern = '.+(?=\\.)')],  "Lower Leg")
  
  ggsave(file.path('Results/Skin_lower_leg', paste('Barplot_',res.notch.SYMBOL.protien[str_extract(sig_norm.proteins[i,1], pattern = '.+(?=\\.)')],'.png', sep = '')))
  
  print(paste(sig_norm.proteins[i,1],' VS Age'))
  print(cor.temp)
}
```
### Correlation plot

```{r}
X = 'NOTCH2'
Y = 'FURIN'
x = which(res.notch.SYMBOL.protien==X)
x = names(res.notch.SYMBOL.protien)[x]
x = which(str_extract(sig_norm.proteins[,1], pattern = '.+(?=\\.)')==x)

y = which(res.notch.SYMBOL.protien==Y)
y = names(res.notch.SYMBOL.protien)[y]
y = which(str_extract(sig_norm.proteins[,1], pattern = '.+(?=\\.)')==y)

x_y = cbind(t(mat.proteins[c(x,y),]), ann.col)
colnames(x_y) <- c(X, Y,'Age')

cor.temp = cor.test(x = x_y[[X]] , y = x_y[[Y]], method = 'pearson')

ggplot(x_y, aes_string(x=X, y=Y)) +
    geom_smooth()+
  geom_point(size = 1, alpha = 1, aes(color = Age))+
  geom_text(x=21000, y=25000, label=paste("rho=", signif(cor.temp$estimate,3), " p=",signif(cor.temp$p.value,3)), sep = '')+
  scale_color_nilou(reverse = TRUE)+
  ggtitle(paste(X,' VS ', Y), "Lower leg")

ggsave(file.path('Results/Skin_lower_leg', paste(X,' vs ', Y, '.png', sep = '')))

print(paste(X,' vs ', Y))
print(cor.temp)
```

# Suprapubic Skin

## Data and metadata

```{r}
metadata.suprapubic <- read.delim("V8/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt")

data.suprapubic <- read.delim('V8/gene_reads_skin_not_sun_exposed_suprapubic.gct', skip = 2)
```

```{r}
counts.suprapubic <- data.suprapubic[,c(-1,-2,-3)]
rownames(counts.suprapubic) <- data.suprapubic$Name
```

```{r}
## Each sample is named after GTEX.ID.XXXX. Extract the code after GTEX as ID
id_data.suprapubic <- str_split(colnames(data.suprapubic)[c(-1,-2,-3)], pattern = "\\.", simplify = TRUE)[,2]

# Change ID in metadata
metadata.suprapubic$ID <- str_split(metadata.suprapubic$SUBJID, pattern = "-", simplify = TRUE)[,2]
metadata.suprapubic$AGE <- factor(metadata.suprapubic$AGE)

# Merge data and metadata
metadata_transfrom.suprapubic <- merge(x = data.frame(ID = id_data.suprapubic, Name = colnames(data.suprapubic)[c(-1,-2,-3)]), y = metadata.suprapubic, by = "ID", all.x = TRUE)
rownames(metadata_transfrom.suprapubic) <- metadata_transfrom.suprapubic$Name
```


```{r}
# Set 20-29 as control
metadata_transfrom.suprapubic$AGE <-  relevel(metadata_transfrom.suprapubic$AGE, ref = '20-29')
```

## Create DESeq2 object

```{r}
dds.suprapubic <- DESeqDataSetFromMatrix(counts.suprapubic, 
                              colData = metadata_transfrom.suprapubic, 
                              design = ~ AGE)
```


### Run DESeq2

```{r}
# Run DESeq2 
dds.suprapubic <- DESeq(dds.suprapubic, test = 'LRT', reduced = ~1)
```

### Results

```{r}
resultsNames(dds.suprapubic)
res.name <- resultsNames(dds.suprapubic)[-1]
```

### notch related DNA/RNA

```{r}
res.list.notch.suprapubic <- list()
for (i in (res.name)){
  res <- results(dds.suprapubic, name = i, test = 'LRT')
  # Turn the results object into a tibble for use with tidyverse functions
  res_tbl <- res %>%
        data.frame() %>%
        rownames_to_column(var="gene") %>%
        as_tibble()

  # Subset the significant results
  notch_res <- dplyr::filter(res_tbl, str_extract(gene, pattern = '.+(?=\\.)') %in% notch_DNA&padj < padj_cutoff) %>%
        dplyr::arrange(padj)
  
  # Save DEG
  res.list.notch.suprapubic[[i]] <- notch_res
}
```

```{r}
res.list.notch.suprapubic
```

```{r}
res.notch.SYMBOL.suprapubic <- mapIds(org.Hs.eg.db, keys = str_extract(res.list.notch.suprapubic[[1]]$gene, pattern = '.+(?=\\.)'), keytype = 'ENSEMBL', column = 'SYMBOL' )
```

#### Notch related proteins

```{r}
res.list.notch.proteins.suprapubic <- list()
for (i in (res.name)){
  res <- results(dds.suprapubic, name = i, test = 'LRT') 
  # Turn the results object into a tibble for use with tidyverse functions
  res_tbl <- res %>%
        data.frame() %>%
        rownames_to_column(var="gene") %>%
        as_tibble()

  # Subset the significant results
  notch_res <- dplyr::filter(res_tbl, str_extract(gene, pattern = '.+(?=\\.)') %in% notch_gene$converted_alias&padj < padj_cutoff) %>%
        dplyr::arrange(padj)
  
  # Save DEG
  res.list.notch.proteins.suprapubic[[i]] <- notch_res
}
```
```{r}
res.list.notch.proteins.suprapubic
```

```{r}
res.notch.SYMBOL.protein.suprapubic <- mapIds(org.Hs.eg.db, keys = str_extract(res.list.notch.proteins.suprapubic[[1]]$gene, pattern = '.+(?=\\.)'), keytype = 'ENSEMBL', column = 'SYMBOL' )
```


### Spearman test on the correlation between age and genes expression value

```{r}
# Get norm conuts
normalized_counts.suprapubic <- counts(dds.suprapubic, normalized = TRUE)
```

DNA/RNA

```{r}

# Get all DEG
DEGs.suprapubic = rownames(counts.suprapubic)
for (i in res.name){
  DEGs.suprapubic <- intersect(DEGs.suprapubic, res.list.suprapubic[[i]]$gene)
}

# Get all DEG notch
DEGs.notch.suprapubic = rownames(counts.suprapubic)
for (i in res.name){
  DEGs.notch.suprapubic <- intersect(DEGs.notch.suprapubic, res.list.notch.suprapubic[[i]]$gene)
}
# Extract normalized counts for only the significant genes
  sig_norm.suprapubic <- data.frame(normalized_counts.suprapubic) %>%
    rownames_to_column(var = "gene") %>%
    dplyr::filter(gene %in% DEGs.notch.suprapubic)

```

```{r}
arrange(metadata_transfrom.suprapubic,AGE) %>%
  select(AGE) -> ann.col.suprapubic

mat.suprapubic <- sig_norm.suprapubic[ , 2:length(colnames(sig_norm.suprapubic))]
mat.suprapubic <- mat.suprapubic[,rownames(ann.col.suprapubic)]
```

```{r}
cor.test.res.suprapubic <- data.frame()
for (i in (1:length(res.notch.SYMBOL.suprapubic))){
  target = res.notch.SYMBOL.suprapubic[i]
  id = names(res.notch.SYMBOL.suprapubic)[i]
  loc = which(str_extract(sig_norm.suprapubic[,1], pattern = '.+(?=\\.)')==id)
  cor.test.res.suprapubic[i,1] <- id #ENSEMBL
  cor.test.res.suprapubic[i,2] <- target #SYMBOL
  
  df <- cbind(t(mat.suprapubic[loc,]), ann.col.suprapubic)
  colnames(df) <- c('Expression', 'Age')
  cor.temp = cor.test(rank(df$Age), y = as.numeric(df$Expression), method = 'spearman')

  cor.test.res.suprapubic[i,3] <- as.numeric(cor.temp[4]) #Rho
  cor.test.res.suprapubic[i,4] <- as.numeric(cor.temp[3]) #Pvalue
}
colnames(cor.test.res.suprapubic) <- c('ENSEMBL', 'SYMBOL', 'Rho', 'Pvalue')
```
```{r}
write.csv(cor.test.res.suprapubic, file = 'Results/Skin_suprapubic/Cor_test_res_suprapubic.csv')
```

Protein

```{r}
DEGs.notch.proteins.suprapubic = rownames(counts.suprapubic)
for (i in res.name){
  DEGs.notch.proteins.suprapubic <- intersect(DEGs.notch.proteins.suprapubic, res.list.notch.proteins.suprapubic[[i]]$gene)
}

sig_norm.proteins.suprapubic <- data.frame(normalized_counts.suprapubic) %>%
    rownames_to_column(var = "gene") %>%
    dplyr::filter(gene %in% DEGs.notch.proteins.suprapubic)

mat.proteins.suprapubic <- sig_norm.proteins.suprapubic[ , 2:length(colnames(sig_norm.proteins.suprapubic))]
mat.proteins.suprapubic <- mat.proteins.suprapubic[,rownames(ann.col.suprapubic)]
```

```{r}
cor.test.res.protein.suprapubic <- data.frame()
for (i in (1:length(res.notch.SYMBOL.protein.suprapubic))){
  target = res.notch.SYMBOL.protein.suprapubic[i]
  id = names(res.notch.SYMBOL.protein.suprapubic)[i]
  loc = which(str_extract(sig_norm.proteins.suprapubic[,1], pattern = '.+(?=\\.)')==id)
  cor.test.res.protein.suprapubic[i,1] <- id #ENSEMBL
  cor.test.res.protein.suprapubic[i,2] <- target #SYMBOL
  
  df <- cbind(t(mat.proteins.suprapubic[loc,]), ann.col.suprapubic)
  colnames(df) <- c('Expression', 'Age')
  cor.temp = cor.test(rank(df$Age), y = as.numeric(df$Expression), method = 'spearman')

  cor.test.res.protein.suprapubic[i,3] <- as.numeric(cor.temp[4]) #Rho
  cor.test.res.protein.suprapubic[i,4] <- as.numeric(cor.temp[3]) #Pvalue
}
colnames(cor.test.res.protein.suprapubic) <- c('ENSEMBL', 'SYMBOL', 'Rho', 'Pvalue')
```
```{r}
write.csv(cor.test.res.protein.suprapubic, file = 'Results/Skin_suprapubic/Cor_test_res_proteins_suprapubic.csv')
```

## Visualization
### Metadata bar plot
```{r}
#png(filename="Metadata_Suprapubic.png")
barplot(table(ann.col.suprapubic$AGE), main="Metadata - Suprapubic") %>%
  text(y = table(ann.col.suprapubic$AGE) - 10, labels = table(ann.col.suprapubic$AGE))
#dev.off()
```

### Boxplot

```{r}
for (n in 1:length(targets)){
  target = targets[n]
  print(target)
  i = which(res.notch.SYMBOL.protien.suprapubic==target)
  i = names(res.notch.SYMBOL.protien.suprapubic)[i]
  i = which(str_extract(sig_norm.proteins.suprapubic[,1], pattern = '.+(?=\\.)')==i)
    
  ggplot(df, aes(x=Age, y=Expression)) +
      geom_boxplot()+
    ggtitle(res.notch.SYMBOL.protien.suprapubic[str_extract(sig_norm.proteins.suprapubic[i,1], pattern = '.+(?=\\.)')],  "Lower Leg")
  
  ggsave(file.path('Results/Skin_lower_leg', paste('Barplot_',res.notch.SYMBOL.protien.suprapubic[str_extract(sig_norm.proteins.suprapubic[i,1], pattern = '.+(?=\\.)')],'.png', sep = '')))
  
  print(paste(sig_norm.proteins.suprapubic[i,1],' VS Age'))
  print(cor.temp)
}
```

### Correlation plot

```{r}
X = 'NOTCH2'
Y = 'FURIN'
x = which(notch.proteins.SYMBOL.suprapubic==X)
x = names(notch.proteins.SYMBOL.suprapubic)[x]
x = which(str_extract(sig_norm.proteins.suprapubic[,1], pattern = '.+(?=\\.)')==x)

y = which(notch.proteins.SYMBOL.suprapubic==Y)
y = names(notch.proteins.SYMBOL.suprapubic)[y]
y = which(str_extract(sig_norm.proteins.suprapubic[,1], pattern = '.+(?=\\.)')==y)

x_y = cbind(t(mat.proteins.suprapubic[c(x,y),]), ann.col.suprapubic)
colnames(x_y) <- c(X, Y,'Age')

cor.temp = cor.test(x = x_y[[X]] , y = x_y[[Y]], method = 'pearson')

ggplot(x_y, aes_string(x=X, y=Y)) +
    geom_smooth()+
  geom_point(size = 1, alpha = 1, aes(color = Age))+
  geom_text(x=21000, y=25000, label=paste("rho=", signif(cor.temp$estimate,3), " p=",signif(cor.temp$p.value,3)), sep = '')+
  scale_color_nilou(reverse = TRUE)+
  ggtitle(paste(X,' VS ', Y), "Suprapubic")

ggsave(file.path('Results/Skin_suprapubic', paste(X,' vs ', Y, '.png', sep = '')))

print(paste(X,' vs ', Y))
print(cor.temp)
```
